<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Route & Rate — Outlook Taskpane</title>
  <style>
    html,body{height:100%;margin:0;font-family:Segoe UI,Roboto,Arial;background:#f6f8fa}
    #root{display:flex;flex-direction:column;height:100%}
    header{padding:10px;background:#fff;border-bottom:1px solid #e9eef6;display:flex;gap:8px;align-items:center}
    button.icon{padding:6px 10px;border-radius:8px;border:1px solid #e2e8ef;background:#fff;cursor:pointer}
    #iframeWrap{flex:1;overflow:hidden}
    iframe{width:100%;height:100%;border:0}
    #status{font-size:13px;color:#475569;padding:8px}
  </style>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
  <div id="root">
    <header>
      <button id="refreshBtn" class="icon" title="Refresh with selected text">↻ Refresh</button>
      <button id="manualBtn" class="icon" title="Manually paste text to send to map">✎ Send Text</button>
      <div style="flex:1"></div>
      <div id="status">Ready</div>
    </header>

    <div id="iframeWrap">
      <iframe id="mapFrame" src="https://jashan11101.github.io/RouteAddin/mapPanel.html" allow="geolocation *; microphone *; camera *"></iframe>
    </div>
  </div>

  <script>
    (function(){
      const MAP_URL = 'https://jashan11101.github.io/RouteAddin/mapPanel.html';
      const frame = document.getElementById('mapFrame');
      const status = document.getElementById('status');
      const refreshBtn = document.getElementById('refreshBtn');
      const manualBtn = document.getElementById('manualBtn');

      function normalizeText(txt){
        if(!txt) return '';
        return txt.replace(/\s+/g,' ').trim();
      }

      function sendToFrame(text){
        text = normalizeText(text);
        if(!text){
          status.innerText = 'No text to send';
          return;
        }
        status.innerText = 'Sending selection...';

        // Refresh iframe with same URL (we're not adding query param as you asked to leave as-is)
        // but we will postMessage with selection so your mapPanel's existing message-listener handles it.
        try {
          frame.src = MAP_URL;
        } catch(e){ /* ignore */ }

        // postMessage after a short delay (gives iframe time to load)
        setTimeout(()=>{
          try {
            frame.contentWindow.postMessage({ type:'setAddress', text }, '*');
            status.innerText = 'Sent: ' + text;
          } catch(e){
            status.innerText = 'Sent (postMessage failed) — iframe refreshed.';
          }
        }, 600);
      }

      function getSelectedTextAndSend(){
        status.innerText = 'Getting selection from Outlook...';
        if (!Office || !Office.context || !Office.context.mailbox) {
          status.innerText = 'Office.js not available';
          return;
        }
        try {
          Office.context.mailbox.item.getSelectedDataAsync(Office.CoercionType.Text, function (result) {
            if (result.status === Office.AsyncResultStatus.Succeeded) {
              const txt = (result.value && result.value.data) ? result.value.data : '';
              if (txt && txt.trim()) {
                sendToFrame(txt);
              } else {
                status.innerText = 'No explicit selection. Trying to read item body...';
                if (Office.context.mailbox.item.body && Office.context.mailbox.item.body.getAsync) {
                  Office.context.mailbox.item.body.getAsync("text", {coercionType: Office.CoercionType.Text}, function(bodyRes){
                    if(bodyRes.status === Office.AsyncResultStatus.Failed){
                      status.innerText = 'Cannot read body: ' + bodyRes.error.message;
                    } else {
                      const bodyText = (bodyRes.value || '').replace(/\r\n/g,' ').replace(/\n/g,' ');
                      const match = bodyText.match(/([A-Za-z0-9 ,.]+?(?:, [A-Za-z]{2,}| [A-Za-z]{2,})?)\s*(?:-|–|—|to|TO|To)\s*([A-Za-z0-9 ,.]+?(?:, [A-Za-z]{2,}| [A-Za-z]{2,})?)/);
                      if(match){
                        sendToFrame(match[0]);
                      } else {
                        status.innerText = 'No route-like text found in body.';
                      }
                    }
                  });
                } else {
                  status.innerText = 'Selection and body read not available.';
                }
              }
            } else {
              status.innerText = 'Selection read failed: ' + (result.error ? result.error.message : 'unknown');
            }
          });
        } catch (e){
          status.innerText = 'Error: ' + e.message;
        }
      }

      refreshBtn.addEventListener('click', getSelectedTextAndSend);
      manualBtn.addEventListener('click', ()=>{
        const manual = prompt('Paste route text (e.g. "Los Angeles, CA - Mississauga, ON")');
        if(manual) sendToFrame(manual);
      });

      Office.initialize = function () {
        setTimeout(()=> getSelectedTextAndSend(), 400);
      };

      // Optional: listen for messages from the iframe to update status
      window.addEventListener('message', (ev)=>{
        if(ev && ev.data && ev.data.type === 'mapReady'){
          status.innerText = 'Map ready';
        }
      });
    })();
  </script>
</body>
</html>
