<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Route & Rate Panel</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 10px; background: #fff; color: #111; }
  #map { width: 100%; height: 60vh; border: 1px solid #ddd; border-radius: 6px; }
  #controls { margin: 8px 0; display:flex; gap:8px; align-items:center; }
  #result { white-space: pre-line; margin-top:8px; font-weight:600; }
  #saveBtn { background:#0078d4; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>
  <h3 style="margin:0 0 8px 0">Route & Rate</h3>

  <div id="controls">
    <label>Rate per mile ($)</label>
    <input id="rateInput" type="number" value="2.5" style="width:80px;padding:6px" />
    <button id="calcBtn" style="padding:6px 10px">Calculate</button>
    <button id="saveBtn">Save to email</button>
  </div>

  <div id="result">Select a route or wait for the extension to set origin/destination.</div>
  <div id="map"></div>

  <!-- Maps JS loaded with your API key (make sure billing + APIs are enabled) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChYFu82xWcUOpUS23eSbuMPgGm7swXuSo&libraries=places"></script>

  <script>
    let map, directionsService, directionsRenderer;
    let currentRoute = { origin: "", destination: "" };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 5,
        center: { lat: 39.5, lng: -98.35 }
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ draggable: true, map: map });
      directionsRenderer.addListener("directions_changed", onDirectionsChanged);
    }

    function calculateRoute(origin, destination) {
      if (!origin || !destination) return;
      currentRoute.origin = origin;
      currentRoute.destination = destination;

      directionsService.route({
        origin,
        destination,
        travelMode: google.maps.TravelMode.DRIVING
      }, (response, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(response);
          updateDistanceRate();
        } else {
          document.getElementById("result").innerText = "Map error: " + status;
        }
      });
    }

    function updateDistanceRate() {
      const directions = directionsRenderer.getDirections();
      if (!directions) return;
      let totalMeters = 0;
      directions.routes[0].legs.forEach(leg => totalMeters += leg.distance.value);
      const miles = totalMeters / 1609.34;
      const rate = parseFloat(document.getElementById("rateInput").value) || 0;
      const usd = (miles * rate).toFixed(2);
      const cad = (miles * rate * 1.35).toFixed(2);
      document.getElementById("result").innerText = `Distance: ${miles.toFixed(1)} miles\nRate: $${usd} USD / C$${cad} CAD`;

      // notify parent extension about the calc (optional)
      window.parent.postMessage({ type: "calculation", result: { miles, usd, cad } }, "*");
    }

    // Save route request - sends message to parent to store (parent will save per email context)
    function saveRouteToParent() {
      window.parent.postMessage({ type: "saveRoute", route: currentRoute }, "*");
      // small feedback
      const btn = document.getElementById("saveBtn");
      btn.textContent = "Saved âœ“";
      setTimeout(()=> btn.textContent = "Save to email", 1500);
    }

    // Listen to parent messages (extension)
    window.addEventListener("message", (ev) => {
      try {
        const data = ev.data;
        if (!data || typeof data !== "object") return;
        if (data.type === "setRoute" || data.origin || data.destination) {
          const origin = data.route ? data.route.origin : data.origin;
          const destination = data.route ? data.route.destination : data.destination;
          if (origin && destination) {
            calculateRoute(origin, destination);
          }
        }
      } catch (e) { console.error(e); }
    });

    document.getElementById("calcBtn").addEventListener("click", updateDistanceRate);
    document.getElementById("saveBtn").addEventListener("click", saveRouteToParent);

    // init after API loaded
    window.initMap = initMap;
    if (window.google && google.maps) initMap();
    else {
      // in case maps loaded later, try again when script available
      const t = setInterval(()=>{ if(window.google && google.maps){ clearInterval(t); initMap(); } }, 300);
    }
  </script>
</body>
</html>
