<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Route & Rate Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --accent:#0078d4; --muted:#666; --bg:#fff; }
    html,body { height:100%; margin:0; font-family: "Segoe UI", Roboto, Arial; background:#f7f9fb; color:#111; }
    #wrap { display:flex; flex-direction:column; height:100vh; padding:8px; box-sizing:border-box; gap:8px; }
    #top { display:flex; gap:8px; align-items:center; }
    .input { padding:8px 10px; border-radius:6px; border:1px solid #d3d8dd; background:#fff; }
    #stopsBox { background:#fff; border:1px solid #e6eaef; border-radius:8px; padding:6px; max-height:150px; overflow:auto; }
    .stopRow { display:flex; align-items:center; gap:8px; padding:6px; border-bottom:1px solid #f2f4f6; }
    .stopRow:last-child { border-bottom:0; }
    .handle { cursor:grab; color:var(--muted); padding:6px; user-select:none; }
    .addr { flex:1; padding:8px; border-radius:6px; border:1px solid #e1e6eb; }
    .btn { background:var(--accent); color:#fff; border:0; padding:8px 10px; border-radius:6px; cursor:pointer; }
    .btn.ghost { background:#efefef; color:#333; }
    #map { flex:1; border-radius:8px; border:1px solid #d9dee3; }
    #bottom { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #totals { font-weight:700; }
    #controlsLeft { display:flex; gap:8px; align-items:center; }
    small.muted { color:var(--muted); }
    .iconBtn { background:transparent; border:0; cursor:pointer; padding:6px; border-radius:6px; }
    #headerRow { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    #headerRow .right { display:flex; gap:6px; align-items:center; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="headerRow">
      <div>
        <strong>Route & Rate</strong> <small class="muted">— interactive panel</small>
      </div>
      <div class="right">
        <button id="helpBtn" class="iconBtn">Help</button>
        <button id="openMapsBtn" class="iconBtn">Open in Maps</button>
        <button id="shareBtn" class="iconBtn">Share</button>
        <button id="minBtn" class="iconBtn">_</button>
        <button id="closeBtn" class="iconBtn">✕</button>
      </div>
    </div>

    <div id="top">
      <input id="origin" class="input" placeholder="Origin (auto)" type="text" style="width:40%"/>
      <input id="destination" class="input" placeholder="Destination (auto)" type="text" style="width:40%"/>
      <button id="addBtn" class="btn">Add drop</button>
    </div>

    <div id="stopsBox" aria-label="stops">
      <!-- dynamic stop rows -->
    </div>

    <div id="map"></div>

    <div id="bottom">
      <div id="controlsLeft">
        <label>Rate per mile (USD)</label>
        <input id="rate" class="input" type="number" value="2.50" style="width:90px"/>
        <button id="saveBtn" class="btn">Save</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div id="totals">
        <span id="distance">Distance: 0.0 mi</span> —
        <span id="usd">$0.00 USD</span> / <span id="cad">C$0.00 CAD</span>
      </div>
    </div>
  </div>

  <!-- Google Maps (use your key) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChYFu82xWcUOpUS23eSbuMPgGm7swXuSo&libraries=places"></script>

  <script>
  (function(){
    const originEl = document.getElementById('origin');
    const destEl = document.getElementById('destination');
    const stopsBox = document.getElementById('stopsBox');
    const addBtn = document.getElementById('addBtn');
    const rateEl = document.getElementById('rate');
    const distanceEl = document.getElementById('distance');
    const usdEl = document.getElementById('usd');
    const cadEl = document.getElementById('cad');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const shareBtn = document.getElementById('shareBtn');
    const openMapsBtn = document.getElementById('openMapsBtn');
    const helpBtn = document.getElementById('helpBtn');
    const minBtn = document.getElementById('minBtn');
    const closeBtn = document.getElementById('closeBtn');

    let map, directionsService, directionsRenderer;
    let stops = []; // array of {id,address}
    let contextRoute = { origin: '', destination: '' };

    function initMap(){
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 39.5, lng: -98.35 },
        zoom: 5,
        gestureHandling: 'greedy' // enable scroll-zoom without ctrl
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map, draggable: true });
      directionsRenderer.addListener('directions_changed', onDirectionsChanged);
    }

    function sanitizeAddr(s){ return (s||'').trim(); }

    function renderStops(){
      stopsBox.innerHTML = '';
      // create origin (read-only)
      const oRow = createRow('origin', contextRoute.origin || '', true);
      stopsBox.appendChild(oRow);
      // stops
      stops.forEach((s, idx) => {
        const r = createRow('stop', s.address, false, idx);
        stopsBox.appendChild(r);
      });
      // create destination (read-only)
      const dRow = createRow('destination', contextRoute.destination || '', true);
      stopsBox.appendChild(dRow);
      attachRowEvents();
    }

    function createRow(type, value, readonly=false, idx){
      const row = document.createElement('div');
      row.className = 'stopRow';
      row.dataset.type = type;
      if (typeof idx !== 'undefined') row.dataset.index = idx;

      const handle = document.createElement('div');
      handle.className = 'handle';
      handle.textContent = '⋮';
      handle.title = 'Drag to reorder';
      if (readonly) handle.style.visibility = 'hidden';
      row.appendChild(handle);

      const input = document.createElement('input');
      input.className = 'addr';
      input.type = 'text';
      input.value = value || '';
      if (readonly) input.readOnly = true;
      row.appendChild(input);

      const del = document.createElement('button');
      del.className = 'btn ghost';
      del.textContent = '✕';
      del.title = 'Remove';
      if (readonly) del.style.visibility = 'hidden';
      row.appendChild(del);

      return row;
    }

    // attach drag & drop + edit events
    function attachRowEvents(){
      const rows = Array.from(stopsBox.querySelectorAll('.stopRow'));
      rows.forEach((row) => {
        const type = row.dataset.type;
        const input = row.querySelector('.addr');
        const del = row.querySelector('button');
        if (type === 'stop') {
          row.draggable = true;
          row.addEventListener('dragstart', (e)=> {
            e.dataTransfer.setData('text/plain', row.dataset.index);
            row.classList.add('dragging');
          });
          row.addEventListener('dragend', ()=> row.classList.remove('dragging'));
        }
        row.addEventListener('dragover', (e)=> { e.preventDefault(); row.style.background='#fafafa'; });
        row.addEventListener('dragleave', ()=> row.style.background='');
        row.addEventListener('drop', (e)=> {
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
          const to = parseInt(row.dataset.index, 10);
          if (!isNaN(from) && !isNaN(to) && from !== to) {
            const [m] = stops.splice(from,1);
            stops.splice(to,0,m);
            renderStops();
            computeRoute();
          }
        });

        input.addEventListener('change', ()=> {
          const t = row.dataset.type;
          if (t === 'origin') { contextRoute.origin = input.value; computeRoute(); }
          else if (t === 'destination') { contextRoute.destination = input.value; computeRoute(); }
          else if (t === 'stop') {
            const idx = parseInt(row.dataset.index,10);
            stops[idx].address = input.value;
            computeRoute();
          }
        });

        if (del) del.addEventListener('click', ()=> {
          if (row.dataset.type === 'stop') {
            const idx = parseInt(row.dataset.index,10);
            stops.splice(idx,1);
            renderStops();
            computeRoute();
          }
        });
      });
    }

    function computeRoute(){
      if (!contextRoute.origin || !contextRoute.destination) return;
      const waypts = stops.map(s => ({ location: s.address, stopover:true }));
      directionsService.route({
        origin: contextRoute.origin,
        destination: contextRoute.destination,
        waypoints: waypts,
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: false
      }, (response, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(response);
          updateTotals(response);
        } else {
          distance.textContent = 'Route error: ' + status;
        }
      });
    }

    function updateTotals(response) {
      let total = 0;
      response.routes[0].legs.forEach(l => total += l.distance.value);
      const miles = total / 1609.34;
      const rate = parseFloat(rateEl.value) || 0;
      const usd = miles * rate;
      const cad = usd * 1.35;
      distanceEl.textContent = 'Distance: ' + miles.toFixed(1) + ' mi';
      usdEl.textContent = '$' + usd.toFixed(2) + ' USD';
      cadEl.textContent = 'C$' + cad.toFixed(2);

      // send calculation to parent (extension) so it can store lastCalc if needed
      window.parent.postMessage({ type:'calculation', result: { miles, usd: usd.toFixed(2), cad: cad.toFixed(2) }}, '*');
    }

    function onDirectionsChanged(){
      const dirs = directionsRenderer.getDirections();
      if (!dirs) return;
      // reorder stops if waypoint_order exists
      const order = dirs.routes[0].waypoint_order || [];
      if (order.length === stops.length) {
        const newStops = order.map(i => stops[i]);
        stops = newStops;
        renderStops();
      }
      updateTotals(dirs);
    }

    // add drop inline
    addBtn.addEventListener('click', ()=> {
      stops.push({ id: Date.now(), address: '' });
      renderStops();
      // focus the last input for typing
      setTimeout(()=> {
        const inputs = stopsBox.querySelectorAll('.addr');
        if (inputs.length) {
          const last = inputs[inputs.length - 1];
          last.focus();
        }
      }, 60);
    });

    // Save handler -> notify parent extension to persist per context
    saveBtn.addEventListener('click', ()=> {
      const payload = { origin: contextRoute.origin, destination: contextRoute.destination, stops: stops.map(s=>s.address), rate: parseFloat(rateEl.value) || 0 };
      window.parent.postMessage({ type:'saveRoute', route: payload }, '*');
      // small UI feedback
      const t = saveBtn.textContent;
      saveBtn.textContent = 'Saved ✓';
      setTimeout(()=> saveBtn.textContent = t, 1300);
    });

    clearBtn.addEventListener('click', ()=> {
      contextRoute = { origin:'', destination:'' };
      stops = [];
      origin.value = ''; destination.value = '';
      renderStops();
      // notify parent to clear if desired
      window.parent.postMessage({ type:'clearRoute' }, '*');
    });

    // share: copy summary to clipboard and open native share if available
    shareBtn.addEventListener('click', async () => {
      const distText = distanceEl.textContent;
      const summary = `${contextRoute.origin} → ${contextRoute.destination}\n${stops.map((s,i)=> (i+1)+'. '+s.address).join('\n')}\n${distText}\nRate per mile: $${(parseFloat(rateEl.value)||0).toFixed(2)}\nTotal: ${usdEl.textContent} / ${cadEl.textContent}`;
      try {
        await navigator.clipboard.writeText(summary);
        // try native share
        if (navigator.share) {
          await navigator.share({ text: summary });
        } else {
          alert('Route copied to clipboard.');
        }
      } catch (e) {
        alert('Could not share/copy: ' + e.message);
      }
    });

    // open in Google Maps - build a directions URL with waypoints (maps URL supports waypoints separated by /)
    openMapsBtn.addEventListener('click', ()=> {
      if (!contextRoute.origin || !contextRoute.destination) return alert('Origin or destination missing.');
      // Build a Google Maps directions URL using query string
      const base = 'https://www.google.com/maps/dir/?api=1';
      const params = new URLSearchParams();
      params.set('origin', contextRoute.origin);
      params.set('destination', contextRoute.destination);
      if (stops.length) params.set('waypoints', stops.map(s=>s.address).join('|'));
      const url = base + '&' + params.toString();
      // Ask parent to open (so popup is not blocked)
      window.parent.postMessage({ type:'openInMaps', url: url }, '*');
    });

    // help button opens a small help overlay (we just open a new tab to google maps help or show minimal alert)
    helpBtn.addEventListener('click', ()=> {
      window.open('https://support.google.com/maps/answer/144339?hl=en', '_blank');
    });

    minBtn.addEventListener('click', ()=> {
      window.parent.postMessage({ type:'minimizePanel' }, '*');
    });
    closeBtn.addEventListener('click', ()=> {
      window.parent.postMessage({ type:'closePanel' }, '*');
    });

    // Handle messages from parent (content.js)
    window.addEventListener('message', (ev) => {
      const d = ev.data || {};
      if (!d) return;
      if (d.type === 'setRoute' && d.route) {
        contextRoute.origin = d.route.origin || contextRoute.origin;
        contextRoute.destination = d.route.destination || contextRoute.destination;
        if (d.route.stops && Array.isArray(d.route.stops)) stops = d.route.stops.map(a=>({id:Date.now()+Math.random(), address:a}));
        // fill the inputs and trigger route
        originEl.value = contextRoute.origin;
        destEl.value = contextRoute.destination;
        renderStops();
        computeRoute();
      } else if (d.type === 'loadSaved' && d.route) {
        contextRoute.origin = d.route.origin || contextRoute.origin;
        contextRoute.destination = d.route.destination || contextRoute.destination;
        stops = (d.route.stops || []).map(a=>({id:Date.now()+Math.random(), address:a}));
        originEl.value = contextRoute.origin;
        destEl.value = contextRoute.destination;
        rateEl.value = d.route.rate || rateEl.value;
        renderStops();
        computeRoute();
      } else if (d.origin && d.destination) {
        contextRoute.origin = d.origin; contextRoute.destination = d.destination;
        originEl.value = contextRoute.origin; destEl.value = contextRoute.destination;
        renderStops();
        computeRoute();
      }
    });

    // small helpers for element references used above
    const origin = originEl, destination = destEl, rateEl = rateEl = rateEl || document.getElementById('rate');
    const distanceEl = distanceEl = distanceEl || document.getElementById('distance');
    const usdEl = usdEl = usdEl || document.getElementById('usd');
    const cadEl = cadEl = cadEl || document.getElementById('cad');

    // init
    function tryInit() {
      if (window.google && google.maps) { initMap(); renderStops(); }
      else setTimeout(tryInit, 300);
    }
    tryInit();

    // route compute helper uses inputs if user manually types them
    origin.addEventListener('change', ()=> { contextRoute.origin = origin.value; computeRoute(); });
    destination.addEventListener('change', ()=> { contextRoute.destination = destination.value; computeRoute(); });
    rateEl.addEventListener('change', ()=> { computeRoute(); });

  })();
  </script>
</body>
</html>
