<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Route Planner & Rate Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        font-family: "Segoe UI", sans-serif;
      }
      #panelHeader {
        background: #0078d4;
        color: white;
        padding: 8px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
      }
      #closePanel {
        background: red;
        border: none;
        border-radius: 50%;
        color: white;
        width: 25px;
        height: 25px;
        cursor: pointer;
      }
      #controls {
        padding: 10px;
        background: #f8f8f8;
      }
      label {
        display: block;
        font-weight: 600;
        margin-top: 5px;
      }
      input, select, button {
        width: 100%;
        padding: 6px;
        margin-top: 3px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        background-color: #0078d4;
        color: white;
        border: none;
        cursor: pointer;
      }
      #waypoints {
        list-style: none;
        padding: 0;
        margin: 5px 0;
      }
      #waypoints li {
        background: #fff;
        margin: 4px 0;
        padding: 6px;
        border: 1px solid #ccc;
        cursor: grab;
        display: flex;
        justify-content: space-between;
      }
      #map {
        height: 55%;
      }
      #output {
        padding: 10px;
        background: #f0f0f0;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  </head>
  <body>
    <div id="panelHeader">
      üó∫Ô∏è Route Planner
      <button id="closePanel">‚úñ</button>
    </div>
    <div id="controls">
      <label>Origin:</label>
      <input id="origin" placeholder="Origin" />

      <label>Destination:</label>
      <input id="destination" placeholder="Destination" />

      <label>Stops:</label>
      <ul id="waypoints"></ul>
      <button id="addStop">+ Add Drop</button>

      <label>Rate per mile ($):</label>
      <input id="rate" type="number" value="2.5" step="0.1" />

      <label>Currency:</label>
      <select id="currency">
        <option>USD</option>
        <option>CAD</option>
        <option>INR</option>
      </select>

      <button id="calc">Calculate</button>
      <button id="share">Share</button>
      <button id="openGoogle">Open in Maps</button>
    </div>
    <div id="map"></div>
    <div id="output"></div>

    <script>
      let map, directionsService, directionsRenderer;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 4,
          center: { lat: 40, lng: -95 },
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          draggable: true,
          map: map,
        });

        new Sortable(document.getElementById("waypoints"), { animation: 150 });

        document.getElementById("addStop").onclick = () => {
          const stop = prompt("Enter Drop Location:");
          if (stop) {
            const li = document.createElement("li");
            li.textContent = stop;
            const del = document.createElement("button");
            del.textContent = "‚úñ";
            del.style.background = "red";
            del.style.color = "white";
            del.style.border = "none";
            del.style.borderRadius = "50%";
            del.style.cursor = "pointer";
            del.onclick = () => li.remove();
            li.appendChild(del);
            document.getElementById("waypoints").appendChild(li);
          }
        };

        document.getElementById("calc").onclick = calcRoute;
        document.getElementById("share").onclick = shareRoute;
        document.getElementById("openGoogle").onclick = openInMaps;
        document.getElementById("closePanel").onclick = () => window.close();

        const params = new URLSearchParams(window.location.search);
        document.getElementById("origin").value = params.get("origin") || "";
        document.getElementById("destination").value = params.get("destination") || "";
      }

      function calcRoute() {
        const origin = document.getElementById("origin").value;
        const destination = document.getElementById("destination").value;
        const stops = Array.from(document.querySelectorAll("#waypoints li"))
          .map((li) => ({ location: li.childNodes[0].textContent.trim(), stopover: true }));

        directionsService.route(
          {
            origin,
            destination,
            waypoints: stops,
            travelMode: google.maps.TravelMode.DRIVING,
            optimizeWaypoints: true,
          },
          (res, status) => {
            if (status === "OK") {
              directionsRenderer.setDirections(res);
              let total = 0;
              const route = res.routes[0];
              route.legs.forEach((leg) => (total += leg.distance.value));
              const miles = (total / 1609.34).toFixed(1);
              const rate = parseFloat(document.getElementById("rate").value);
              const currency = document.getElementById("currency").value;
              const cost = (miles * rate).toFixed(2);
              document.getElementById(
                "output"
              ).innerHTML = `<b>${miles} miles</b><br>Total: ${currency} ${cost}`;
            } else {
              alert("Route request failed: " + status);
            }
          }
        );
      }

      function shareRoute() {
        const text = document.getElementById("output").innerText;
        if (navigator.share) {
          navigator.share({ title: "Route Info", text });
        } else {
          alert("Copy this route info:\n\n" + text);
        }
      }

      function openInMaps() {
        const o = encodeURIComponent(document.getElementById("origin").value);
        const d = encodeURIComponent(document.getElementById("destination").value);
        const stops = Array.from(document.querySelectorAll("#waypoints li"))
          .map((li) => encodeURIComponent(li.childNodes[0].textContent.trim()))
          .join("/");
        window.open(`https://www.google.com/maps/dir/${o}/${stops}/${d}`, "_blank");
      }
    </script>
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChYFu82xWcUOpUS23eSbuMPgGm7swXuSo&callback=initMap">
    </script>
  </body>
</html>
