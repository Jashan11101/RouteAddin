<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Route & Rate ‚Äî Map Panel (Draggable Stops + Autocomplete + Share)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --primary:#0078d4; --muted:#eef2f6; --card:#fff; --ui-font:"Segoe UI",Roboto,Arial;
    }
    html,body{height:100%;margin:0;font-family:var(--ui-font);background:#f6f8fa;overflow:hidden}
    #container{display:flex;flex-direction:column;height:100%}
    #top{display:flex;flex-wrap:wrap;gap:8px;padding:10px;align-items:center;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 1px 0 rgba(0,0,0,0.04);z-index:10}
    .input{background:var(--card);border:1px solid #e2e8ef;padding:8px;border-radius:8px;box-shadow:0 1px 4px rgba(12,20,30,0.03);display:flex;align-items:center;gap:6px}
    input[type="text"], input[type="number"], select{border:none;outline:none;background:transparent;font-size:14px}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;background:var(--muted);border:none;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.06);transition:transform .12s,background .12s}
    .icon-btn:hover{transform:translateY(-2px);background:#e6f2ff}
    .icon-btn.primary{background:var(--primary);color:#fff}
    #middle{display:flex;gap:12px;padding:12px;flex:1;box-sizing:border-box;overflow:hidden}
    #left{width:380px;min-width:240px;max-width:420px;display:flex;flex-direction:column;gap:12px;overflow:auto}
    #stopsCard{background:var(--card);border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(12,20,30,0.04);display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto}
    #stopsList{list-style:none;margin:0;padding:6px;display:flex;flex-direction:column;gap:8px}
    li.stop-item{display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #e8eef6;padding:6px;border-radius:8px}
    .stop-handle{cursor:grab;padding:6px;border-radius:6px;color:#6b7581}
    .stop-input{flex:1;padding:6px;border-radius:6px;border:1px solid transparent;background:transparent;font-size:14px}
    .stop-actions{display:flex;gap:6px}
    .small-ic{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;background:var(--muted);border:none;cursor:pointer}
    .small-ic:hover{background:#e6f2ff;transform:translateY(-1px)}
    #mapWrap{flex:1;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(12,20,30,0.04)}
    #map{width:100%;height:100%;min-height:420px}
    #bottom{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;background:#fff;border-top:1px solid #e9eef6;box-shadow:0 -2px 8px rgba(12,20,30,0.02);position:sticky;bottom:0;z-index:20}
    #output{font-weight:700;font-size:15px;color:#0b2a43}
    .muted{color:#475569;font-size:13px}
    /* share popup */
    #sharePopup{position:absolute;right:18px;top:70px;background:#fff;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.12);padding:8px;display:none;flex-direction:column;gap:8px;z-index:99999}
    .share-row{display:flex;gap:8px;align-items:center}
    .share-link{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#f6f8fb;border:1px solid #eef2f6;text-decoration:none;color:#0b2a43}
    @media(max-width:900px){#middle{flex-direction:column;padding:8px}#left{width:auto;max-width:100%}#map{min-height:360px}}
   </style>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="top">
      <div style="display:flex;gap:8px">
            <button id="addStopBtn" class="icon-btn" title="Add location"><span>Ôºã</span></button>
            <button id="clearStops" class="icon-btn" title="Clear all"><span>üóëÔ∏è</span></button>
          </div>

      <div class="input" style="max-width:120px">
        <input id="rate" type="number" value="2.5" step="0.1" />
      </div>

      <div class="input" style="max-width:96px">
        <select id="currency"><option>CAD</option><option>USD</option></select>
      </div>

      <button id="calcBtn" class="icon-btn primary" title="Calculate route"><span>üìç</span></button>
      <div style="flex:1"></div>
      <button id="shareUiBtn" class="icon-btn" title="Share route"><span>üîó</span></button>
    </div>

    <div id="middle">
      <div id="left">
        <div style="display:flex;justify-content:space-between;align-items:center">
      
          <ul id="stopsList"></ul>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button id="saveBtn" class="icon-btn" title="Save route"><span>üóÉÔ∏è</span></button>
          <button id="openFullBtn" class="icon-btn" title="Open in Google Maps"><span>üó∫Ô∏è</span></button>
        </div>
      </div>

      <div id="mapWrap">
        <div id="map"></div>
      </div>
    </div>

    <div id="bottom">
      <div>
        <div class="muted">Route:</div>
        <div id="routeSummary" class="muted">Not calculated</div>
      </div>
      <div id="output">Distance: 0.0 mi ‚Äî CAD 0.00 / USD 0.00</div>
    </div>
  </div>

  <div id="sharePopup" role="dialog" aria-hidden="true">
    <div class="share-row">
      <a id="waLink" class="share-link" target="_blank" rel="noopener">WhatsApp</a>
      <a id="mailLink" class="share-link">Outlook/Email</a>
    </div>
    <div class="share-row">
      <button id="copyShare" class="icon-btn" title="Copy to clipboard">üìã</button>
      <button id="nativeShare" class="icon-btn" title="Native share">üì§</button>
    </div>
  </div>

<script>
/* ---------- Configuration ---------- */
const MAP_API_KEY = 'AIzaSyChYFu82xWcUOpUS23eSbuMPgGm7swXuSo';
const DEFAULT_RATE = 2.5;
let map, directionsService, directionsRenderer;
let autocompleteSearch; // top search box autocomplete
const stopsList = document.getElementById('stopsList');

/* ---------- Map init ---------- */
function initMap(){
  map = new google.maps.Map(document.getElementById('map'), { center:{lat:39.5,lng:-98.35}, zoom:5, gestureHandling:'greedy' });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map: map, draggable: true });
  directionsRenderer.addListener('directions_changed', onDirectionsChanged);

  // init searchBox autocomplete (top small box)
  const searchBoxEl = document.getElementById('searchBox');
  autocompleteSearch = new google.maps.places.Autocomplete(searchBoxEl, { types:['(cities)'] });
  autocompleteSearch.addListener('place_changed', () => {
    const place = autocompleteSearch.getPlace();
    if(!place || !place.formatted_address) return;
    // add as new top location and autofocus input
    addStop(place.formatted_address);
    // clear search text
    searchBoxEl.value = '';
  });
}

/* ---------- Stop item creation + places autocomplete for each input ---------- */
function createStop(value=''){
  const li = document.createElement('li');
  li.className = 'stop-item';
  li.innerHTML = `
    <div class="stop-handle" title="Drag">‚ãÆ‚ãÆ</div>
    <input class="stop-input" value="${value.replace(/"/g,'&quot;')}" placeholder="City, Province/State"/>
    <div class="stop-actions">
      <button class="small-ic insert-after" title="Insert after">Ôºã</button>
      <button class="small-ic remove" title="Remove">‚úï</button>
    </div>`;
  const input = li.querySelector('.stop-input');

  // Attach a Places Autocomplete to this input
  // Note: we create after the element is attached to DOM for Google API to work reliably
  setTimeout(()=> {
    try {
      const ac = new google.maps.places.Autocomplete(input, { types:['(cities)'] });
      ac.setFields(['formatted_address','address_components','geometry','name']);
      ac.addListener('place_changed', () => {
        const p = ac.getPlace();
        if(p && p.formatted_address) input.value = p.formatted_address;
      });
    } catch(e){}
  }, 50);

  li.querySelector('.remove').onclick = () => { li.remove(); };
  li.querySelector('.insert-after').onclick = () => { const newLi = createStop(''); li.after(newLi); newLi.querySelector('.stop-input').focus(); };
  input.addEventListener('keyup', (ev)=>{ if(ev.key==='Enter') computeRoute(); });

  return li;
}
function addStop(val=''){ const el = createStop(val); stopsList.appendChild(el); el.querySelector('.stop-input').focus(); }

/* Make stops sortable (draggable) */
new Sortable(stopsList, { animation:150, handle:'.stop-handle', onEnd: ()=>{ /* after reorder */ } });

/* ---------- Compute route logic (first = origin, last = destination) ---------- */
function computeRoute(){
  const nodes = Array.from(document.querySelectorAll('.stop-input')).map(i=>i.value.trim()).filter(Boolean);
  if(nodes.length < 2){ alert('Please add at least 2 locations (origin + destination)'); return; }
  const origin = nodes[0], destination = nodes[nodes.length-1], stops = nodes.slice(1, nodes.length-1);
  const waypoints = stops.map(s=>({location:s, stopover:true}));

  directionsService.route({
    origin, destination, waypoints, travelMode:google.maps.TravelMode.DRIVING, optimizeWaypoints:false
  }, (res,status) => {
    if(status === 'OK'){
      directionsRenderer.setDirections(res);
      let total = 0; res.routes[0].legs.forEach(l=> total += l.distance.value);
      const miles = total/1609.34;
      const rate = parseFloat(document.getElementById('rate').value) || DEFAULT_RATE;
      const currency = document.getElementById('currency').value || 'CAD';
      const cost = (miles * rate).toFixed(2);
      const usd = (currency === 'CAD') ? (cost * 0.73).toFixed(2) : (currency === 'USD' ? cost : (cost/83).toFixed(2));
      document.getElementById('output').innerText = `Distance: ${miles.toFixed(1)} mi ‚Äî ${currency} ${cost} (‚âà USD ${usd})`;
      document.getElementById('routeSummary').innerText = `${origin} ‚Üí ${stops.join(' ‚Üí ')}${stops.length? ' ‚Üí ' : ''}${destination}`;
      // store last computed for share
      window.lastRouteData = { origin, stops, destination, miles: miles.toFixed(1), cost, currency, usd };
    } else {
      document.getElementById('output').innerText = 'Route error: ' + status;
    }
  });
}

/* When user drags route directly on map (DirectionRenderer draggable) */
function onDirectionsChanged(){
  const dirs = directionsRenderer.getDirections(); if(!dirs) return;
  let total = 0; dirs.routes[0].legs.forEach(l=> total += l.distance.value);
  const miles = total/1609.34;
  const rate = parseFloat(document.getElementById('rate').value) || DEFAULT_RATE;
  const currency = document.getElementById('currency').value || 'CAD';
  const cost = (miles * rate).toFixed(2);
  const usd = (currency === 'CAD') ? (cost * 0.73).toFixed(2) : (currency === 'USD' ? cost : (cost/83).toFixed(2));
  document.getElementById('output').innerText = `Distance: ${miles.toFixed(1)} mi ‚Äî ${currency} ${cost} (‚âà USD ${usd})`;
  document.getElementById('routeSummary').innerText = 'Route updated (map)';
  window.lastRouteData = { miles: miles.toFixed(1), cost, currency, usd }; // minimal
}

/* ---------- Share popup logic ---------- */
const sharePopup = document.getElementById('sharePopup');
document.getElementById('shareUiBtn').addEventListener('click', (e)=>{
  sharePopup.style.display = sharePopup.style.display === 'flex' ? 'none' : 'flex';
  positionSharePopup();
});
function positionSharePopup(){
  const rect = document.getElementById('shareUiBtn').getBoundingClientRect();
  sharePopup.style.top = (rect.bottom + 8) + 'px';
  sharePopup.style.right = '18px';
}

/* Create share links (WhatsApp / Mailto) */
function buildShareText(){
  const data = window.lastRouteData || {};
  const origin = data.origin || (document.querySelector('.stop-input')? document.querySelector('.stop-input').value : '');
  const stops = data.stops ? data.stops.join(' -> ') : Array.from(document.querySelectorAll('.stop-input')).map(i=>i.value).slice(1,-1).join(' -> ');
  const dest = data.destination || (Array.from(document.querySelectorAll('.stop-input')).pop()? Array.from(document.querySelectorAll('.stop-input')).pop().value : '');
  const miles = data.miles || '0.0';
  const cost = data.cost || '0.00';
  const currency = data.currency || document.getElementById('currency').value;
  const usd = data.usd || '0.00';
  const routeLine = origin + (stops ? ' -> ' + stops : '') + (dest ? ' -> ' + dest : '');
  return `Route: ${routeLine}\nDistance: ${miles} mi\nEstimated: ${currency} ${cost} (‚âà USD ${usd})`;
}

/* WhatsApp link */
document.getElementById('waLink').addEventListener('click', (e)=>{
  const txt = encodeURIComponent(buildShareText());
  const url = `https://wa.me/?text=${txt}`;
  window.open(url, '_blank');
});

/* Mail (mailto) */
document.getElementById('mailLink').addEventListener('click', (e)=>{
  const body = encodeURIComponent(buildShareText());
  const subject = encodeURIComponent('Route & Rate');
  const mailto = `mailto:?subject=${subject}&body=${body}`;
  // open in new tab for web clients
  window.location.href = mailto;
});

/* Copy and native share */
document.getElementById('copyShare').addEventListener('click', async ()=>{
  const text = buildShareText();
  try { await navigator.clipboard.writeText(text); alert('Copied to clipboard'); } catch(e){ alert('Copy failed'); }
});
document.getElementById('nativeShare').addEventListener('click', async ()=>{
  const text = buildShareText();
  if(navigator.share){ try { await navigator.share({ title:'Route & Rate', text }); } catch(e){ /* user canceled */ } }
  else { alert('Native share not supported'); }
});

/* ---------- UI wiring ---------- */
document.getElementById('addStopBtn').addEventListener('click', ()=> addStop(''));
document.getElementById('clearStops').addEventListener('click', ()=> stopsList.innerHTML = '');
document.getElementById('openFullBtn').addEventListener('click', ()=>{
  const nodes = Array.from(document.querySelectorAll('.stop-input')).map(i=>i.value.trim()).filter(Boolean);
  if(nodes.length < 2){ alert('Add at least origin and destination'); return; }
  const origin = encodeURIComponent(nodes[0]);
  const destination = encodeURIComponent(nodes[nodes.length-1]);
  const waypoints = nodes.slice(1, nodes.length-1).map(s=>encodeURIComponent(s)).join('|');
  const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypoints}`;
  window.open(url, '_blank');
});
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const nodes = Array.from(document.querySelectorAll('.stop-input')).map(i=>i.value.trim()).filter(Boolean);
  localStorage.setItem('route.saved', JSON.stringify({ nodes, rate: document.getElementById('rate').value, currency: document.getElementById('currency').value }));
  alert('Saved locally');
});
document.getElementById('calcBtn').addEventListener('click', computeRoute);

/* ---------- Support receiving selected text from parent (iframe) or query param ---------- */
function setFromText(txt){
  if(!txt) return;
  // parse into multiple parts (A - B or A to B or many parts)
  txt = txt.replace(/\s+/g,' ').trim();
  const parts = txt.split(/\s*(?:[-‚Äì‚Äî]|to|TO|To)\s*/i).map(p=>p.trim()).filter(Boolean);
  stopsList.innerHTML = '';
  parts.forEach(p => addStop(p));
}
window.addEventListener('message', (ev)=>{
  try {
    const d = ev.data || {};
    if(d && d.type === 'setAddress' && d.text) setFromText(d.text);
  } catch (e){}
});
(function(){
  const q = new URLSearchParams(location.search).get('text');
  if(q) setFromText(decodeURIComponent(q));
})();

/* ---------- expose initMap for Google callback ---------- */
window.initMap = initMap;
</script>

<!-- Google Maps + Places (places library is required for autocomplete) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChYFu82xWcUOpUS23eSbuMPgGm7swXuSo&libraries=places&callback=initMap"></script>
</body>
</html>


