<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Route & Rate Panel</title>
<link rel="stylesheet" href="panel.css" />

<style>
  :root {
    --accent: #0078d4;
    --light-bg: #f3f4f6;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: #fff;
    color: #222;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: var(--accent);
    color: #fff;
    padding: 10px 14px;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header button {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
  }

  #mapContainer {
    flex: 1;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  #map {
    flex: 1;
    border-radius: 6px;
    overflow: hidden;
  }

  #stopsList {
    background: var(--light-bg);
    padding: 6px 10px;
    border-radius: 6px;
    margin: 6px 10px;
    font-size: 14px;
    min-height: 90px;
  }

  .stopItem {
    display: flex;
    align-items: center;
    background: #fff;
    border-radius: 6px;
    margin-bottom: 6px;
    padding: 6px 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    cursor: grab;
  }

  .stopItem input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 14px;
  }

  .stopItem .icon {
    margin-right: 6px;
    color: var(--accent);
  }

  footer {
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
    background: #f9fafb;
    border-top: 1px solid #ddd;
    position: sticky;
    bottom: 0;
  }

  footer button {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 13px;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 5px;
  }

  footer button:hover {
    background: #005ea6;
  }

  #details {
    text-align: center;
    font-size: 14px;
    padding: 4px 0;
    color: #555;
  }

  .hidden { display: none; }
</style>
</head>

<body>
  <header>
    <span>Route & Rate</span>
    <button id="closeBtn" title="Close Panel">‚úï</button>
  </header>

  <div id="mapContainer">
    <div id="stopsList"></div>
    <div id="details"></div>
    <div id="map"></div>
  </div>

  <footer>
    <button id="btnSave" title="Save Route">üíæ Save</button>
    <button id="btnShare" title="Share Route">üîó Share</button>
    <button id="btnGoogle" title="Open in Google Maps">üåç Open</button>
  </footer>

  <script>
    let map, directionsService, directionsRenderer;
    let stops = [];

    const urlParams = new URLSearchParams(location.search);
    const selText = decodeURIComponent(urlParams.get("text") || "").trim();

    document.getElementById("closeBtn").addEventListener("click", () => {
      window.parent.postMessage({ type: "closePanel" }, "*");
    });

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 43.7, lng: -79.42 },
        zoom: 6,
        mapTypeControl: false,
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });

      if (selText) {
        parseSelection(selText);
      }
    }

    function parseSelection(text) {
      const routePattern = /(.+?)(?:\s*[-‚Äì‚Äî]\s*|\s+to\s+)(.+)/i;
      let from = "", to = "";
      if (routePattern.test(text)) {
        const m = text.match(routePattern);
        from = m[1].trim();
        to = m[2].trim();
      } else {
        from = text.trim();
      }

      if (from) stops.push({ label: from });
      if (to) stops.push({ label: to });
      renderStops();
      if (stops.length >= 2) calcRoute();
    }

    function renderStops() {
      const list = document.getElementById("stopsList");
      list.innerHTML = "";
      stops.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "stopItem";
        div.draggable = true;
        div.dataset.index = i;

        div.innerHTML = `<span class="icon">üìç</span><input value="${s.label}" />`;
        list.appendChild(div);

        div.addEventListener("dragstart", e => {
          e.dataTransfer.setData("text/plain", i);
        });
        div.addEventListener("dragover", e => e.preventDefault());
        div.addEventListener("drop", e => {
          const fromIdx = +e.dataTransfer.getData("text/plain");
          const toIdx = +e.currentTarget.dataset.index;
          const [moved] = stops.splice(fromIdx, 1);
          stops.splice(toIdx, 0, moved);
          renderStops();
          if (stops.length >= 2) calcRoute();
        });
      });
    }

    function calcRoute() {
      if (stops.length < 2) return;
      const origin = stops[0].label;
      const destination = stops[stops.length - 1].label;
      const waypoints = stops.slice(1, -1).map(s => ({ location: s.label, stopover: true }));

      directionsService.route(
        { origin, destination, waypoints, travelMode: "DRIVING" },
        (res, status) => {
          if (status === "OK" && res.routes.length) {
            directionsRenderer.setDirections(res);
            const leg = res.routes[0].legs.reduce((a, l) => {
              a.distance += l.distance.value;
              a.duration += l.duration.value;
              return a;
            }, { distance: 0, duration: 0 });
            const distKm = (leg.distance / 1000).toFixed(1);
            const hrs = (leg.duration / 3600).toFixed(1);
            document.getElementById("details").textContent = `Distance: ${distKm} km | Duration: ${hrs} hrs`;
          } else {
            document.getElementById("details").textContent = "Unable to find route.";
          }
        }
      );
    }

    document.getElementById("btnSave").addEventListener("click", () => {
      const text = stops.map(s => s.label).join(" ‚Üí ");
      const blob = new Blob([text], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "route.txt";
      a.click();
    });

    document.getElementById("btnGoogle").addEventListener("click", () => {
      if (stops.length < 2) return;
      const origin = encodeURIComponent(stops[0].label);
      const destination = encodeURIComponent(stops[stops.length - 1].label);
      const waypoints = stops.slice(1, -1).map(s => encodeURIComponent(s.label)).join("/");
      let url = `https://www.google.com/maps/dir/${origin}/${waypoints ? waypoints + "/" : ""}${destination}`;
      window.open(url, "_blank");
    });

    document.getElementById("btnShare").addEventListener("click", async () => {
      const text = stops.map(s => s.label).join(" ‚Üí ");
      const info = document.getElementById("details").textContent;
      const message = `Route: ${text}\n${info}`;
      try {
        await navigator.share({ text: message });
      } catch (err) {
        alert("Sharing not supported. Copy manually:\n\n" + message);
      }
    });
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>
</body>
</html>
